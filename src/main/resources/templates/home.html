<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
<!--    libs for stomp and sockjs-->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<!--    end libs for stomp and sockjs-->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
	rel="stylesheet" type="text/css">
<link href="style.css" rel="stylesheet">

<style type="text/css">
.hide {
	display: none;
}
</style>
</head>
<body>
	<h2 th:text="${user.name}"></h2>
	<h2 th:text="${user.mobile}" id="mobilenum"></h2>
	<button onclick="addUser()" id="addButton">ADD Mobile</button>
	<button onclick="addGroup()" id="addButton">ADD Group</button>
	<div id="adderform" class="hide">
		<form th:action="adduser" id="addForm">
			Add Mobile: <input type="text" id="mobile">
			<button type="submit">ADD</button>
		</form>
	</div>
	<div id="addergroup" class="hide">
		<form th:action="addgroup" id="addgroup">
			Add Group: <input type="text" id="group">
			<button type="submit">ADD</button>
		</form>
	</div>
	<div>
		<div class="container clearfix">
			<div class="people-list" id="people-list">
				<div class="search">
					<input id="userName" placeholder="search" type="text" />
				</div>
				<ul class="list" id="usersList">


				</ul>
			</div>
			<div class="chat">
				<div class="chat-header clearfix">
					<!-- <img alt="avatar" height="55px"
						src="https://rtfm.co.ua/wp-content/plugins/all-in-one-seo-pack/images/default-user-image.png"
						width="55px" /> -->

					<div class="chat-about">
						<div class="chat-with" id="selectedUserId"></div>
						<div class="chat-num-messages"></div>
					</div>
					<i class="fa fa-star"></i>
				</div>
				<!-- end chat-header -->

				<div class="chat-history">
					<ul>

					</ul>

				</div>
				<!-- end chat-history -->

				<div class="chat-message clearfix">
					<textarea id="message-to-send" name="message-to-send"
						placeholder="Type your message" rows="3"></textarea>

					<i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp; <i
						class="fa fa-file-image-o"></i>

					<button id="sendBtn">Send</button>

				</div>
				<!-- end chat-message -->

			</div>
			<!-- end chat -->

		</div>
		<!-- end container -->

	</div>

<script id="message-template" type="text/x-handlebars-template">
    <li class="clearfix">
        <div class="message-data align-right">
            <span class="message-data-time">{{time}}</span> &nbsp; &nbsp;
            <span class="message-data-name">You</span> <i class="fa fa-circle me"></i>
        </div>
        <div class="message other-message float-right">
            {{messageOutput}}
	<button onclick="deletemessage('{{messageid}}')" >delete</button>
	{{messageid}}
        </div>
    </li>
</script>

<script id="message-response-template" type="text/x-handlebars-template">
    <li>
        <div class="message-data">
            <span class="message-data-name"><i class="fa fa-circle online"></i> {{userName}}</span>
            <span class="message-data-time">{{time}}</span>
        </div>
        <div class="message my-message">
            {{response}}
        </div>
    </li>
</script>

<script src="custom.js"></script>

</body>

<script type="text/javascript">
const url = 'http://localhost:8080';
let stompClient;
let selectedUser;
let toMessage;
let newMessages = new Map();

function connectToChat(userName) {
    console.log("connecting to chat...")
    let socket = new SockJS(url + '/chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
    	console.log("connected to: " + frame);
        stompClient.subscribe("/topic/messages/" + userName, function (response) {
        	let data = JSON.parse(response.body);
      	    if (selectedUser == data.fromLogin) {
                render(data.message, data.fromLogin);
            } else if(data.message==userName){
            	fecthmessages(selectedUser)
            }else {
                newMessages.set(data.fromLogin, data.message);
             	$('#newmessage_'+data.fromLogin).append(`<span id=newmessageNotify_${data.fromLogin} style=color: red>+1</span>`);
            }
             
        });
        
        stompClient.subscribe("/topic/status/" + userName, function (response) {
          	let data = JSON.parse(response.body);
        	if(data.online=='online'){
        		document.getElementById('online_'+data.mobile).innerHTML='  online';
        		$('#online_'+data.mobile).show();		
        	}else if(data.online=='ofline'){
         	  $('#online_'+data.mobile).hide();	
        	}
               
          });
        stompClient.subscribe("/topic/offlineMessage/" + userName, function (response) {
        	let data = JSON.parse(response.body);
        	console.log(data)
        	for(var i = 0;i<data.length;i++){
        	   $('#oflineMessage_'+data[i]).innerHTML=''; 	
        	   $('#newmessage_'+data[i]).append(`<span id=oflineMessage_${data[i]} style=color: red>+1</span>`);
		}
        });
        stompClient.subscribe("/topic/groupMessage/" + userName, function (response) {
        	let data = JSON.parse(response.body);
        	 if (selectedUser == data.toGroup) {
        	 console.log(selectedUser+"==="+data.toGroup)
                 render(data.message, data.fromLogin);
             	}else {
               	 console.log(selectedUser+"!=="+data.toGroup)
                 newMessages.set(data.toMobile, data.message);
              	$('#newmessage_'+data.toGroup).append(`<span id=newmessageNotify_${data.toGroup} style=color: red>+1</span>`);
             }
        }); 
    });
}
console.log($('#mobilenum').text())
connectToChat($('#mobilenum').text());

setTimeout(function(){
	sendOnlineMessage();
 	}, 2000);
const fecthmessages = (userName) => {
	console.log("fetchmessages")
	$.ajax({
		type : "POST",
		contentType : "application/json",
		url :  "getUserChat",
		data : JSON.stringify(userName),
		dataType : 'json',
		success : function(data) {
			console.log(data)
			$chatHistoryList.html('')
			for(var i = 0;i<data.length;i++){
			if(data[i].toMobile==userName){
				var template = Handlebars.compile($("#message-template").html());
				var context = {
					    messageid:	data[i].id,
				            messageOutput: data[i].message,
				            time:data[i].date,
				            toUserName: data[i].toMobile,
				            fromUser:data[i].fromMobile
				        };
				$chatHistoryList.append(template(context));
			}else{
				var templateResponse = Handlebars.compile($("#message-response-template").html());
				var contextResponse = {
				    messageid:	data[i].id, 		
				    response: data[i].message,
			            time:data[i].date,
			            userName : data[i].fromMobile
			        };
			        $chatHistoryList.append(templateResponse(contextResponse));
				}
			} 
		} 
  	 });
}

const fetchGroupChat = (groupName) => {
	console.log(groupName)
	$.ajax({
		type : "POST",
		contentType : "application/json",
		url :  "getGroupChat",
		data : JSON.stringify(groupName),
		dataType : 'json',
		success : function(data) {
			console.log(data)
			$chatHistoryList.html('')
			for(var i = 0;i<data.length;i++){
			if(data[i].fromMobile==[[${user.mobile}]]){
				var template = Handlebars.compile($("#message-template").html());
				var context = {
					    messageid:	data[i].id,
				            messageOutput: data[i].message,
				            time:data[i].date,
				            toUserName: data[i].toMobile,
				            fromUser:data[i].fromMobile
				        };
				$chatHistoryList.append(template(context));
			}else{
				var templateResponse = Handlebars.compile($("#message-response-template").html());
				var contextResponse = {
				    messageid:	data[i].id, 		
				    response: data[i].message,
			            time:data[i].date,
			            userName : data[i].fromMobile
			        };
			        $chatHistoryList.append(templateResponse(contextResponse));
				}
			} 
		} 
  	 });
}

function sendMsg(from, text) {
   if(toMessage==0){
	stompClient.send("/app/chat/" + selectedUser, {}, JSON.stringify({
       		 fromLogin: from,
      		 message: text,
       		 date:getCurrentTime()
    }));
   }else{
	stompClient.send("/app/group/" + selectedUser, {}, JSON.stringify({
	       fromLogin: from,
	       message: text,
	       date:getCurrentTime()
	    }));  
   }
}

function sendDeleteMsg(userName) {
    stompClient.send("/app/chat/delete/" + selectedUser, {}, JSON.stringify({
        message: userName,
    }));
}

function sendReadNotify() {
    stompClient.send("/app/chat/read/" + selectedUser, {}, JSON.stringify({
        message:'readsuccessfully',
    }));
}

function sendOnlineMessage(){
	stompClient.send("/app/chat/online", {}, JSON.stringify({
        mobile:[[${user.mobile}]],
    }));
}

function sendDeleteOfflineMessages(receiver,sender){
	stompClient.send("/app/chat/offlinemessage", {}, JSON.stringify({
	toMobile:receiver,
	fromMobile:sender
    }));
}

function sendDeleteOfflineGroupMessages(userName,groupName){
	stompClient.send("/app/chat/offlineGroupMessage", {}, JSON.stringify({
	toMobile:userName,
	fromMobile:groupName
    }));
}


function selectUser(userName) {
    toMessage=0;	
    console.log("selecting users: " + userName);
    selectedUser = userName;
    /* let isNew = document.getElementById("newMessage_" + userName) !== null;
    if (isNew) {
        let element = document.getElementById("newMessage_" + userName);
        element.parentNode.removeChild(element);
        render(newMessages.get(userName), userName);
    } */
    $('#selectedUserId').html('');
    $('#selectedUserId').append('Chat with ' + userName);
    $('#newmessageNotify_'+selectedUser).hide();
    $('#oflineMessage_'+selectedUser).hide();
    sendDeleteOfflineMessages([[${user.mobile}]],userName);
    fecthmessages(userName);
}
function selectGroup(groupName) {
    toMessage=1;	
    console.log("selecting users: " + groupName);
    console.log('dsaddsa');
    selectedUser = groupName;
    $('#selectedUserId').html('');
    $('#selectedUserId').append('Chat with ' + groupName);
    $('#newmessageNotify_'+selectedUser).hide();
    $('#oflineMessage_'+selectedUser).hide();
    sendDeleteOfflineGroupMessages([[${user.mobile}]],groupName);
    fetchGroupChat(groupName)
}

const getAllGroupAddedByUser = () => {
	$.ajax({
		type : "POST",
		contentType : "application/json",
		url :  "getAllGroupAddedByUser",
		data : JSON.stringify([[${user.mobile}]]),
		dataType : 'json',
		success : function(data) {
			for(var i = 0;i<data.length;i++){
		    		 $('#usersList').append(`<a href=# onclick=selectGroup('${data[i].groupName}')><li id=newmessage_${data[i].groupName}>${data[i].groupName}(Group)</li></a>`) 
			}  
		}
	   });
}

const getAllUserAddedByUser = () => {
	$.ajax({
			type : "POST",
			contentType : "application/json",
			url :  "getAllUserAddedByUser",
			data : JSON.stringify([[${user.mobile}]]),
			dataType : 'json',
			success : function(data) {
				$('#usersList').html('');
				for(var i = 0;i<data.length;i++){
			    		$('#usersList').append(`<a href=# onclick=selectUser('${data[i].mobile}') ><li id=newmessage_${data[i].mobile} >${data[i].name}<span  id=online_${data[i].mobile}>${data[i].status}</span></li></a>`)
				} 
			}
		   });
	}

 getAllUserAddedByUser();
 
 setTimeout(function(){
	 getAllGroupAddedByUser();
 },500);
 

	var i =0;
	const addUser = () => {
		if(i==0){
			document.getElementById('adderform').classList.remove('hide');
			document.getElementById('addergroup').classList.add('hide');
			i=1;
		}else{
			document.getElementById('adderform').classList.add('hide');
			i=0;
		    }
		}
	var j =0;
	const addGroup = () => {
		if(j==0){
			document.getElementById('addergroup').classList.remove('hide');
			document.getElementById('adderform').classList.add('hide');
			j=1;
		}else{
			document.getElementById('addergroup').classList.add('hide');
			j=0;
		    }
		}
	
	$('#addForm').submit(function(event){
		event.preventDefault();
		 $.ajax({
  			type : "POST",
  			contentType : "application/json",
  			url :  "adduser",
  			data : JSON.stringify($('#mobile').val()),
  			dataType : 'json',
  			success : function(data) {
  				if(data.status=="done"){
  					$('#mobile').val('');
  					getAllUserAddedByUser();
  					setTimeout(function(){
  						 getAllGroupAddedByUser();
  					 },500);
  				}else if(data.status=="not exists"){
  					alert("not exists")
  				}else if(data.status=="alreadyAdded"){
  					alert("Already added")
  				}else{
  					alert("try again")
  				}
  			}
  		   });
		})
		
	$('#addgroup').submit(function(event){
		event.preventDefault();
		 $.ajax({
  			type : "POST",
  			contentType : "application/json",
  			url :  "addgroup",
  			data : JSON.stringify($('#group').val()),
  			dataType : 'json',
  			success : function(data) {
  				$('#group').val('');
  				setTimeout(function(){
  					 getAllGroupAddedByUser();
  				 },500);
  				 getAllUserAddedByUser();
  			}
  		   });
		})
	
	const  deletemessage = (messageid) => {
		if (confirm("Are you sure?")) {
			fecthmessages(selectedUser);
			$.ajax({
	  			type : "POST",
	  			contentType : "application/json",
	  			url :  "deleteuser",
	  			data : JSON.stringify(messageid),
	  			dataType : 'json',
	  			success : function(data) {
	  				if(data.status=="done"){
	  					sendDeleteMsg(selectedUser);
	  					fecthmessages(selectedUser);
	  				}else{
	  					alert("try again")
	  				}
	  			}
	  		   })	
			} 
		}	
	 	
	
		
</script>

</html>